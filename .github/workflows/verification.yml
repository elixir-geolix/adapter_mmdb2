name: Verification

on:
  pull_request:
  push:
    branches:
      - master
      - test
    tags:
      - '*'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-24.04

    steps:
    - uses: actions/checkout@v5
      with:
        persist-credentials: false

    - name: setup-python
      uses: actions/setup-python@v6
      with:
        python-version: '3.8'

    - name: setup
      id: setup
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.14.2'
        otp-version: '25.0'

    - name: mix-cache
      uses: actions/cache@v4
      id: mix-cache
      with:
        path: deps
        key: ${{ runner.os }}-${{ steps.setup.outputs.otp-version }}-${{ steps.setup.outputs.elixir-version }}-mix-${{ hashFiles(format('{0}{1}', github.workspace, '/mix.lock')) }}

    - name: mix-deps
      if: steps.mix-cache.outputs.cache-hit != 'true'
      run: |
        mix local.rebar --force
        mix local.hex --force
        mix deps.get

    - name: pip-deps
      run: |
        python -m pip install --upgrade pip
        pip install geoip2

    - name: download
      env:
        MAXMIND_ACCOUNT_ID: ${{ secrets.MAXMIND_ACCOUNT_ID }}
        MAXMIND_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
      run: |
        mkdir data
        cd data

        wget -q --content-disposition --user="${MAXMIND_ACCOUNT_ID}" --password="${MAXMIND_LICENSE_KEY}" "https://download.maxmind.com/geoip/databases/GeoLite2-ASN/download?suffix=tar.gz" -O GeoLite2-ASN.tar.gz
        wget -q --content-disposition --user="${MAXMIND_ACCOUNT_ID}" --password="${MAXMIND_LICENSE_KEY}" "https://download.maxmind.com/geoip/databases/GeoLite2-City/download?suffix=tar.gz" -O GeoLite2-City.tar.gz
        wget -q --content-disposition --user="${MAXMIND_ACCOUNT_ID}" --password="${MAXMIND_LICENSE_KEY}" "https://download.maxmind.com/geoip/databases/GeoLite2-Country/download?suffix=tar.gz" -O GeoLite2-Country.tar.gz

        tar -xzf GeoLite2-ASN.tar.gz
        tar -xzf GeoLite2-City.tar.gz
        tar -xzf GeoLite2-Country.tar.gz

        find . -name '*.mmdb' -exec mv {} . \;

    - name: verify
      run: |
        cd verify

        . ./generate_ip_set.sh

        cd geolix && mix geolix.verify && cd -
        cd python && python3 verify.py && cd -

        diff geolix_results.txt python_results.txt
